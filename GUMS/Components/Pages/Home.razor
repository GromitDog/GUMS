@page "/"
@using Microsoft.AspNetCore.Authorization
@using GUMS.Data.Enums
@using GUMS.Services
@attribute [Authorize]
@rendermode InteractiveServer
@inject IPersonService PersonService
@inject IAttendanceService AttendanceService
@inject ITermService TermService
@inject IMeetingService MeetingService
@inject IConfigurationService ConfigService
@inject IPaymentService PaymentService

<PageTitle>Home - GUMS</PageTitle>

<div class="container-fluid py-4">
    <h1>Welcome to @(!string.IsNullOrEmpty(_unitName) ? _unitName : "your unit")!</h1>
    <p class="lead">Manage your Girlguiding unit with ease</p>

    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Member Register</h5>
                    @if (_isLoading)
                    {
                        <div class="text-center py-2">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            @if (_leaderCount > 0)
                            {
                                <p class="card-text mb-1">
                                    <strong>@_leaderCount</strong> @(_leaderCount == 1 ? "Leader" : "Leaders")
                                </p>
                            }
                            @if (_rainbowCount > 0)
                            {
                                <p class="card-text mb-1">
                                    <strong>@_rainbowCount</strong> @(_rainbowCount == 1 ? "Rainbow" : "Rainbows")
                                </p>
                            }
                            @if (_brownieCount > 0)
                            {
                                <p class="card-text mb-1">
                                    <strong>@_brownieCount</strong> @(_brownieCount == 1 ? "Brownie" : "Brownies")
                                </p>
                            }
                            @if (_guideCount > 0)
                            {
                                <p class="card-text mb-1">
                                    <strong>@_guideCount</strong> @(_guideCount == 1 ? "Guide" : "Guides")
                                </p>
                            }
                            @if (_rangerCount > 0)
                            {
                                <p class="card-text mb-1">
                                    <strong>@_rangerCount</strong> @(_rangerCount == 1 ? "Ranger" : "Rangers")
                                </p>
                            }
                            @if (_totalCount == 0)
                            {
                                <p class="card-text text-muted">No active members yet.</p>
                            }
                        </div>
                    }
                    <a href="/Register" class="btn btn-primary">Manage Members</a>
                </div>
            </div>
        </div>

        <!-- Meetings Card -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Meetings</h5>
                    @if (_isLoading)
                    {
                        <div class="text-center py-2">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            @if (_nextMeetingDate.HasValue)
                            {
                                <p class="card-text mb-1">
                                    <strong>Next meeting:</strong> @_nextMeetingDate.Value.ToString("ddd dd MMM")
                                </p>
                            }
                            <p class="card-text mb-1">
                                <strong>@_upcomingMeetingCount</strong> upcoming @(_upcomingMeetingCount == 1 ? "meeting" : "meetings")
                            </p>
                        </div>
                    }
                    <a href="/Meetings" class="btn btn-primary">View Meetings</a>
                </div>
            </div>
        </div>

        <!-- Attendance Alerts Card -->
        <div class="col-md-4">
            <div class="card @(_alertCount > 0 ? "border-warning" : "")">
                <div class="card-body">
                    <h5 class="card-title">
                        Attendance Alerts
                        @if (_alertCount > 0)
                        {
                            <span class="badge bg-warning text-dark ms-2">@_alertCount</span>
                        }
                    </h5>
                    @if (_isLoading)
                    {
                        <div class="text-center py-2">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else if (_currentTermName == null)
                    {
                        <p class="card-text text-muted">No active term configured.</p>
                        <a href="/Configuration/Terms" class="btn btn-outline-secondary">Configure Terms</a>
                    }
                    else
                    {
                        <div class="mb-3">
                            <p class="card-text mb-1">
                                <small class="text-muted">Current term: @_currentTermName</small>
                            </p>
                            @if (_alertCount == 0)
                            {
                                <p class="card-text text-success">
                                    <i class="bi bi-check-circle"></i> No attendance concerns
                                </p>
                            }
                            else
                            {
                                @if (_fullTermAbsenceCount > 0)
                                {
                                    <p class="card-text mb-1 text-danger">
                                        <i class="bi bi-exclamation-triangle"></i> <strong>@_fullTermAbsenceCount</strong> full-term @(_fullTermAbsenceCount == 1 ? "absence" : "absences")
                                    </p>
                                }
                                @if (_lowAttendanceCount > 0)
                                {
                                    <p class="card-text mb-1 text-warning">
                                        <i class="bi bi-exclamation-circle"></i> <strong>@_lowAttendanceCount</strong> low attendance
                                    </p>
                                }
                            }
                        </div>
                        <a href="/Meetings/Alerts" class="btn @(_alertCount > 0 ? "btn-warning" : "btn-primary")">
                            @if (_alertCount > 0)
                            {
                                <span>Review Alerts</span>
                            }
                            else
                            {
                                <span>View Details</span>
                            }
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Second row -->
    <div class="row mt-4">
        <!-- Payments Card -->
        <div class="col-md-4">
            <div class="card @(_overduePaymentCount > 0 ? "border-danger" : "")">
                <div class="card-body">
                    <h5 class="card-title">
                        Payments
                        @if (_overduePaymentCount > 0)
                        {
                            <span class="badge bg-danger ms-2">@_overduePaymentCount overdue</span>
                        }
                    </h5>
                    @if (_isLoading)
                    {
                        <div class="text-center py-2">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            <p class="card-text mb-1">
                                <strong>@_pendingPaymentCount</strong> pending @(_pendingPaymentCount == 1 ? "payment" : "payments")
                            </p>
                            <p class="card-text mb-1">
                                Outstanding: <strong class="@(_totalOutstanding > 0 ? "text-danger" : "text-success")">@_totalOutstanding.ToString("C")</strong>
                            </p>
                        </div>
                        <div>
                            <a href="/Payments" class="btn @(_overduePaymentCount > 0 ? "btn-danger" : "btn-primary") me-2">
                                @if (_overduePaymentCount > 0)
                                {
                                    <span>View Overdue</span>
                                }
                                else
                                {
                                    <span>Manage Payments</span>
                                }
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>