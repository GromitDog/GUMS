@page "/Meetings/Edit/{MeetingId:int}"
@using GUMS.Data.Enums
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@rendermode InteractiveServer

<PageTitle>Edit Meeting - GUMS</PageTitle>

<div class="container-fluid py-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/Meetings">Meetings</a></li>
            <li class="breadcrumb-item active">Edit Meeting</li>
        </ol>
    </nav>

    @if (_isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (_meeting == null)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle-fill"></i> Meeting not found.
        </div>
    }
    else
    {
        <h2 class="mb-4">Edit Meeting</h2>

        @if (_meeting.Date < DateTime.Today)
        {
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Note:</strong> This meeting is in the past. Changes may affect historical records.
            </div>
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i> @_errorMessage
                <button type="button" class="btn-close" @onclick="ClearError"></button>
            </div>
        }

        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header" style="background-color: var(--gg-primary-blue); color: white;">
                        <h5 class="mb-0">
                            <i class="bi bi-pencil"></i> Meeting Details
                        </h5>
                    </div>
                    <div class="card-body">
                        <EditForm Model="_meeting" OnValidSubmit="SaveMeeting">
                            <DataAnnotationsValidator />

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Date</label>
                                    <InputDate class="form-control" @bind-Value="_meeting.Date" />
                                    <ValidationMessage For="@(() => _meeting.Date)" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Type</label>
                                    <InputSelect class="form-select" @bind-Value="_meeting.MeetingType">
                                        <option value="@MeetingType.Regular">Regular Meeting</option>
                                        <option value="@MeetingType.Extra">Special Event</option>
                                    </InputSelect>
                                </div>

                                <div class="col-md-12">
                                    <label class="form-label">Title</label>
                                    <InputText class="form-control" @bind-Value="_meeting.Title" />
                                    <ValidationMessage For="@(() => _meeting.Title)" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Start Time</label>
                                    <InputDate Type="InputDateType.Time" class="form-control" @bind-Value="_startTime" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">End Time</label>
                                    <InputDate Type="InputDateType.Time" class="form-control" @bind-Value="_endTime" />
                                </div>

                                <div class="col-md-12">
                                    <label class="form-label">Location Name</label>
                                    <InputText class="form-control" @bind-Value="_meeting.LocationName" />
                                    <ValidationMessage For="@(() => _meeting.LocationName)" />
                                </div>

                                <div class="col-md-12">
                                    <label class="form-label">Location Address (Optional)</label>
                                    <InputTextArea class="form-control" @bind-Value="_meeting.LocationAddress" rows="2" />
                                </div>

                                <div class="col-md-12">
                                    <label class="form-label">Description (Optional)</label>
                                    <InputTextArea class="form-control" @bind-Value="_meeting.Description" rows="3" />
                                </div>

                                @if (_meeting.MeetingType == MeetingType.Extra)
                                {
                                    <div class="col-12">
                                        <div class="card" style="background-color: #FFF9E6; border-color: #FFE08A;">
                                            <div class="card-body">
                                                <h6 class="card-title">
                                                    <i class="bi bi-currency-pound"></i> Cost Information
                                                </h6>

                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <label class="form-label">Cost Per Attendee (Â£)</label>
                                                        <InputNumber class="form-control" @bind-Value="_meeting.CostPerAttendee"
                                                                   placeholder="0.00" step="0.01" />
                                                    </div>

                                                    @if (_meeting.CostPerAttendee.HasValue && _meeting.CostPerAttendee.Value > 0)
                                                    {
                                                        <div class="col-md-6">
                                                            <label class="form-label">Payment Deadline</label>
                                                            <InputDate class="form-control" @bind-Value="_meeting.PaymentDeadline" />
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>

                            <!-- Activities Section -->
                            <div class="mt-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0">Activities</h6>
                                    <button type="button" class="btn btn-sm btn-outline-primary" @onclick="AddActivity">
                                        <i class="bi bi-plus-circle"></i> Add Activity
                                    </button>
                                </div>

                                @if (_activities.Any())
                                {
                                    <div class="list-group">
                                        @for (int i = 0; i < _activities.Count; i++)
                                        {
                                            var index = i;
                                            var activity = _activities[i];
                                            <div class="list-group-item">
                                                <div class="row g-2 align-items-center">
                                                    <div class="col-md-6">
                                                        <input type="text" class="form-control form-control-sm"
                                                               placeholder="Activity name"
                                                               @bind="activity.Name" />
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox"
                                                                   id="consent-@index"
                                                                   @bind="activity.RequiresConsent" />
                                                            <label class="form-check-label" for="consent-@index">
                                                                Requires consent
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2 text-end">
                                                        <button type="button" class="btn btn-outline-danger"
                                                                @onclick="() => RemoveActivity(index)"
                                                                title="Remove activity">
                                                            <i class="bi bi-x-lg"></i> Remove
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="row g-2 mt-2">
                                                    <div class="col-12">
                                                        <textarea class="form-control form-control-sm"
                                                                  rows="2"
                                                                  placeholder="Activity notes (optional)"
                                                                  @bind="activity.Description"></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <p class="text-muted">No activities for this meeting.</p>
                                }
                            </div>

                            <div class="mt-4 d-flex gap-2">
                                <button type="submit" class="btn btn-primary" disabled="@_isSaving">
                                    @if (_isSaving)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    }
                                    <i class="bi bi-save"></i> Save Changes
                                </button>
                                <a href="/Meetings/View/@MeetingId" class="btn btn-secondary">Cancel</a>
                                <button type="button" class="btn btn-outline-danger ms-auto" @onclick="ShowDeleteConfirm">
                                    <i class="bi bi-trash"></i> Delete Meeting
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card" style="background-color: #E3F2FD;">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="bi bi-info-circle"></i> Editing Tips
                        </h6>
                        <ul class="mb-0">
                            <li>Changes to past meetings may affect historical records</li>
                            <li>Activities are managed separately - add or remove as needed</li>
                            <li>You can't delete meetings that have attendance recorded</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        @if (_showDeleteConfirm)
        {
            <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">
                                <i class="bi bi-exclamation-triangle-fill"></i> Confirm Deletion
                            </h5>
                            <button type="button" class="btn-close btn-close-white" @onclick="CancelDelete"></button>
                        </div>
                        <div class="modal-body">
                            <p>Are you sure you want to delete <strong>@_meeting.Title</strong>?</p>
                            <p class="text-muted">
                                This action cannot be undone. You cannot delete meetings that have attendance recorded.
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CancelDelete">
                                Cancel
                            </button>
                            <button type="button" class="btn btn-danger" @onclick="DeleteMeeting" disabled="@_isDeleting">
                                @if (_isDeleting)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                }
                                <i class="bi bi-trash"></i> Delete Meeting
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>
